{% extends "admin/base.html" %}
{% block title %}EC2 Status{% endblock %}

{% block content %}
<div class="container">
    <div class="row">
        <div class="col-md-12">
            <h1>EC2 Challenge Status</h1>
            <hr>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title">Active Instances</h5>
                        </div>
                        <div class="card-body">
                            <div id="active-instances">
                                <div class="text-center">
                                    <i class="fas fa-circle-notch fa-spin"></i> Loading...
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title">Configuration Status</h5>
                        </div>
                        <div class="card-body">
                            <div id="config-status">
                                <div class="text-center">
                                    <i class="fas fa-circle-notch fa-spin"></i> Loading...
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="row mt-4">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title">Instance History</h5>
                        </div>
                        <div class="card-body">
                            <div id="instance-history">
                                <div class="text-center">
                                    <i class="fas fa-circle-notch fa-spin"></i> Loading...
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    loadActiveInstances();
    loadConfigStatus();
    loadInstanceHistory();
    
    // Refresh every 30 seconds
    setInterval(function() {
        loadActiveInstances();
        loadConfigStatus();
    }, 30000);
});

function loadActiveInstances() {
    fetch('/api/v1/ec2')
        .then(response => response.json())
        .then(data => {
            const container = document.getElementById('active-instances');
            
            if (data.success && data.data) {
                if (data.data.length === 0) {
                    container.innerHTML = '<p class="text-muted">No active instances</p>';
                } else {
                    let html = '<div class="table-responsive"><table class="table table-sm"><thead><tr><th>User</th><th>Challenge</th><th>Instance</th><th>Started</th><th>Actions</th></tr></thead><tbody>';
                    
                    data.data.forEach(instance => {
                        const startTime = new Date(instance.timestamp * 1000).toLocaleString();
                        html += `<tr>
                            <td>${instance.owner_id}</td>
                            <td>Challenge ${instance.challenge_id}</td>
                            <td><code>${instance.instance_id}</code></td>
                            <td>${startTime}</td>
                            <td>
                                <button class="btn btn-sm btn-danger" onclick="stopInstance('${instance.instance_id}')">
                                    <i class="fas fa-bomb"></i> Nuke
                                </button>
                            </td>
                        </tr>`;
                    });
                    
                    html += '</tbody></table></div>';
                    container.innerHTML = html;
                }
            } else {
                container.innerHTML = '<p class="text-danger">Failed to load active instances</p>';
            }
        })
        .catch(error => {
            console.error('Error loading active instances:', error);
            document.getElementById('active-instances').innerHTML = '<p class="text-danger">Error loading active instances</p>';
        });
}

function loadConfigStatus() {
    fetch('/api/v1/ec2_config/status')
        .then(response => response.json())
        .then(data => {
            const container = document.getElementById('config-status');
            
            if (data.success && data.data) {
                let html = '<ul class="list-unstyled">';
                html += `<li><i class="fas fa-${data.data.config_valid ? 'check text-success' : 'times text-danger'}"></i> Configuration Valid</li>`;
                html += `<li><i class="fas fa-${data.data.has_credentials ? 'check text-success' : 'times text-danger'}"></i> AWS Credentials</li>`;
                html += '</ul>';
                
                if (!data.data.config_valid) {
                    html += '<div class="alert alert-warning mt-2"><small>Please configure EC2 settings in the <a href="/admin/ec2_config">EC2 Configuration</a> page.</small></div>';
                }
                
                container.innerHTML = html;
            } else {
                container.innerHTML = '<p class="text-danger">Failed to load configuration status</p>';
            }
        })
        .catch(error => {
            console.error('Error loading config status:', error);
            document.getElementById('config-status').innerHTML = '<p class="text-danger">Error loading configuration status</p>';
        });
}

function loadInstanceHistory() {
    // This would typically come from a separate API endpoint
    const container = document.getElementById('instance-history');
    container.innerHTML = '<p class="text-muted">Instance history feature coming soon...</p>';
}

function stopInstance(instanceId) {
    if (confirm('Are you sure you want to nuke this instance?')) {
        // Use GET method to avoid CSRF issues (like ECS plugin does)
        fetch(`/api/v1/ec2_stop_instance?instance_id=${instanceId}`, {
            method: 'GET',
            credentials: 'same-origin'
        })
            .then(response => {
                // Check if response is OK before trying to parse JSON
                if (!response.ok) {
                    // If not OK, try to get error message
                    return response.text().then(text => {
                        try {
                            return JSON.parse(text);
                        } catch {
                            throw new Error(`HTTP ${response.status}: ${text.substring(0, 100)}`);
                        }
                    });
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    loadActiveInstances();
                } else {
                    alert('Failed to nuke instance: ' + (data.error || data.message || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error nuking instance:', error);
                alert('Error nuking instance: ' + error.message);
            });
    }
}
</script>
{% endblock %}
