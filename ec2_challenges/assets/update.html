{% extends "admin/challenges/update.html" %}
{% block category %}
<div class="form-group">
    <label>
        Category:<br>
        <small class="form-text text-muted">Challenge Category</small>
    </label>
    <input type="text" class="form-control chal-category" name="category" value="{{ challenge.category }}">
</div>
<div class="form-group">
    <label for="ami_id_select" id="ami_id_label">AMI ID:</label>
    <select id="ami_id_select" name="ami_id" class="form-control" required>
        <option value="">Select an AMI...</option>
    </select>
    <small class="form-text text-muted">
        Choose the AMI to use for this challenge
    </small>
</div>
<div class="form-group">
    <label for="subnet_id_select" id="subnet_id_label">Subnet ID:</label>
    <select id="subnet_id_select" name="subnet_id" class="form-control" required>
        <option value="">Select a subnet...</option>
    </select>
    <small class="form-text text-muted">
        Choose the subnet for the EC2 instance
    </small>
</div>
<div class="form-group">
    <label for="instance_type_select" id="instance_type_label">Instance Type:</label>
    <select id="instance_type_select" name="instance_type" class="form-control">
        <option value="t2.micro">t2.micro - 1 vCPU, 1 GB RAM</option>
        <option value="t2.small">t2.small - 1 vCPU, 2 GB RAM</option>
        <option value="t2.medium">t2.medium - 2 vCPU, 4 GB RAM</option>
        <option value="t3.micro">t3.micro - 2 vCPU, 1 GB RAM</option>
        <option value="t3.small">t3.small - 2 vCPU, 2 GB RAM</option>
        <option value="t3.medium">t3.medium - 2 vCPU, 4 GB RAM</option>
    </select>
</div>
<div class="form-group">
    <label for="security_group_select" id="security_group_label">Security Group:</label>
    <select id="security_group_select" name="security_group" class="form-control" required>
        <option value="">Select a security group...</option>
    </select>
    <small class="form-text text-muted">
        Choose the security group for the EC2 instance
    </small>
</div>
<div class="form-group">
    <label for="key_name">Key Pair Name:</label>
    <input type="text" class="form-control" name="key_name" value="{{ challenge.key_name }}">
    <small class="form-text text-muted">
        EC2 key pair name for SSH access
    </small>
</div>
<div class="form-group">
    <label for="scheme">Connection Scheme (Optional):</label>
    <select id="scheme" name="scheme" class="form-control">
        <option value="">None</option>
        <option value="http">HTTP</option>
        <option value="https">HTTPS</option>
        <option value="ssh">SSH</option>
        <option value="ftp">FTP</option>
        <option value="sftp">SFTP</option>
    </select>
    <small class="form-text text-muted">
        Protocol scheme to prepend to the IP address (e.g., http://203.0.113.30)
    </small>
</div>
<div class="form-group">
    <label for="port">Port (Optional):</label>
    <input type="text" class="form-control" name="port" value="{{ challenge.port }}" maxlength="10">
    <small class="form-text text-muted">
        Port number to append to the IP address (e.g., 203.0.113.30:3000)
    </small>
</div>
<div class="form-group">
    <label for="setup_script">Setup Script:</label>
    <textarea id="setup_script" class="form-control" name="setup_script" rows="10">{{ challenge.setup_script }}</textarea>
    <small class="form-text text-muted">
        Bash script to run when the instance starts (optional)
    </small>
</div>
<div class="form-group">
    <label for="guide">Guide:</label>
    <textarea id="guide" class="form-control markdown" name="guide" rows="10">{{ challenge.guide }}</textarea>
    <small class="form-text text-muted">
        Markdown guide for solving the challenge
    </small>
</div>
<div class="form-group">
    <label for="auto_stop_time">Auto-stop Time (seconds):</label>
    <input type="number" class="form-control" name="auto_stop_time" value="{{ challenge.auto_stop_time }}" min="300" max="7200">
    <small class="form-text text-muted">
        Time in seconds before the instance is automatically stopped (300-7200)
    </small>
</div>
{% endblock %}
{% block footer %}
<script>
    // Define current values for the update.js script
    var EC2_AMI_ID = '{{ challenge.ami_id }}';
    var EC2_INSTANCE_TYPE = '{{ challenge.instance_type }}';
    var EC2_SECURITY_GROUP = '{{ challenge.security_group }}';
    var EC2_KEY_NAME = '{{ challenge.key_name }}';
    var EC2_SUBNET_ID = '{{ challenge.subnet_id }}';
    var EC2_SCHEME = '{{ challenge.scheme }}';
    var EC2_PORT = '{{ challenge.port }}';
    var EC2_SETUP_SCRIPT = {{ challenge.setup_script | tojson }};
    var EC2_GUIDE = {{ challenge.guide | tojson }};
    var EC2_AUTO_STOP_TIME = {{ challenge.auto_stop_time }};
    
    // Set form values (these don't depend on API calls) - using vanilla JS
    document.addEventListener('DOMContentLoaded', function() {
        var instanceTypeSelect = document.querySelector("#instance_type_select");
        if (instanceTypeSelect && EC2_INSTANCE_TYPE) {
            instanceTypeSelect.value = EC2_INSTANCE_TYPE;
        }
        var schemeSelect = document.querySelector("#scheme");
        if (schemeSelect && EC2_SCHEME) {
            schemeSelect.value = EC2_SCHEME;
        }
        var portInput = document.querySelector("#port");
        if (portInput && EC2_PORT) {
            portInput.value = EC2_PORT;
        }
        var setupScriptTextarea = document.querySelector("#setup_script");
        if (setupScriptTextarea && EC2_SETUP_SCRIPT) {
            setupScriptTextarea.value = EC2_SETUP_SCRIPT;
        }
        var guideTextarea = document.querySelector("#guide");
        if (guideTextarea && EC2_GUIDE) {
            guideTextarea.value = EC2_GUIDE;
        }
        var keyNameInput = document.querySelector("#key_name");
        if (keyNameInput && EC2_KEY_NAME) {
            keyNameInput.value = EC2_KEY_NAME;
        }
        var autoStopTimeInput = document.querySelector("input[name='auto_stop_time']");
        if (autoStopTimeInput && EC2_AUTO_STOP_TIME) {
            autoStopTimeInput.value = EC2_AUTO_STOP_TIME;
        }
    });
</script>
{% endblock %}
